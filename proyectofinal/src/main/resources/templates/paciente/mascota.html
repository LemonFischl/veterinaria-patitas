<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patitas al Rescate - Gestión de Mascota</title>
    <th:block th:insert="~{fragmentos :: Links-css}"/>
</head>
<body>
<!-- Cabecera -->
<div th:replace="~{fragmentos :: Cabecera}"></div>

<div class="container-fluid mt-4 mb-5 px-4">
    <div class="row g-4">
        <!-- FORMULARIO DE REGISTRO -->
        <div class="col-lg-5 col-md-6">
            <div class="form-card">
                <div class="card-header-custom">
                    <h4 class="mb-0">
                        <i class="fa-solid fa-paw me-2"></i>Registrar Mascota
                    </h4>
                </div>
                <div class="p-4">
                    <form method="post" th:action="@{/paciente/mascota/guardar}" th:object="${mascota}" class="compact-form">
                        <!-- Mensaje de éxito -->
                        <div th:if="${exito}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <span th:text="${exito}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>

                        <!-- Mensaje de error -->
                        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <span th:text="${error}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>

                        <input type="hidden" th:field="*{id_mascota}"/>

                        <div class="mb-3">
                            <label for="nombre" class="form-label"><i class="bi bi-tag me-1 text-primary"></i>Nombre</label>
                            <input type="text" class="form-control" th:field="*{nombre}" id="nombre" placeholder="Ej. Firulais">
                            <div th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}" class="text-danger small"></div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="tipo" class="form-label"><i class="bi bi-box me-1 text-primary"></i>Tipo</label>
                                <input type="text" class="form-control" th:field="*{tipo}" id="tipo" placeholder="Perro, gato...">
                                <div th:if="${#fields.hasErrors('tipo')}" th:errors="*{tipo}" class="text-danger small"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="raza" class="form-label"><i class="bi bi-fingerprint me-1 text-primary"></i>Raza</label>
                                <input type="text" class="form-control" th:field="*{raza}" id="raza" placeholder="Labrador...">
                                <div th:if="${#fields.hasErrors('raza')}" th:errors="*{raza}" class="text-danger small"></div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fechaNacimiento" class="form-label"><i class="bi bi-calendar2-week me-1 text-primary"></i>Fecha Nac.</label>
                                <input type="date" class="form-control" th:field="*{fechaNacimiento}" id="fechaNacimiento">
                                <div th:if="${#fields.hasErrors('fechaNacimiento')}" th:errors="*{fechaNacimiento}" class="text-danger small"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="genero" class="form-label"><i class="bi bi-gender-ambiguous me-1 text-primary"></i>Género</label>
                                <select class="form-select" th:field="*{genero}" id="genero" required>
                                    <option value="" disabled selected>Seleccione</option>
                                    <option th:value="MACHO">Macho</option>
                                    <option th:value="HEMBRA">Hembra</option>
                                    <option th:value="OTRO">Otro</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="observacionesMedicas" class="form-label"><i class="bi bi-journal-medical me-1 text-primary"></i>Observaciones Médicas</label>
                            <textarea id="observacionesMedicas" class="form-control" th:field="*{observacionesMedicas}" rows="2"></textarea>
                            <div th:if="${#fields.hasErrors('observacionesMedicas')}" th:errors="*{observacionesMedicas}" class="text-danger small"></div>
                        </div>

                        <!-- Usuario (Dueño) -->
                        <div th:if="${#authorization.expression('!hasRole(''ROLE_PACIENTE'')')}" class="mb-3">
                            <label class="form-label"><i class="bi bi-person me-1 text-primary"></i>Dueño</label>
                            <select class="form-select" th:field="*{usuario.id_usuario}">
                                <option value="" disabled selected>Seleccione un usuario</option>
                                <option th:each="u : ${usuarios}" th:value="${u.id_usuario}" th:text="${u.nombre + ' (' + u.username + ')'}"></option>
                            </select>
                            <div th:if="${#fields.hasErrors('usuario')}" th:errors="*{usuario}" class="text-danger small"></div>
                        </div>
                        <input type="hidden" th:if="${#authorization.expression('hasRole(''ROLE_PACIENTE'')')}" th:field="*{usuario.id_usuario}" th:value="${usuarios[0].id_usuario}"/>

                        <!-- Botones -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <button type="submit" class="btn btn-success px-4">
                                <i class="bi bi-check-circle me-2"></i>Guardar Mascota
                            </button>
                            <a href="/paciente/mascota/nuevo" class="btn btn-outline-secondary px-4">
                                <i class="bi bi-x-circle me-2"></i>Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- TABLA DE MASCOTAS -->
        <div class="col-lg-7 col-md-6">
            <div class="table-card">
                <div class="card-header-custom">
                    <h4 class="mb-0"><i class="bi bi-collection me-2"></i>Lista de Mascotas</h4>
                </div>
                <div class="table-responsive px-3 pb-3 pe-4">
                    <table class="tablaData table table-compact table-hover mb-0">
                        <thead class="text-center">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>Raza</th>
                            <th class="text-start">Nac.</th>
                            <th>Género</th>
                            <th>Dueño</th>
                            <th>Alerta</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="m : ${mascotas}" class="align-middle">
                            <td class="text-center fw-bold" th:text="${m.id_mascota}"></td>
                            <td th:text="${m.nombre}" class="text-truncate" style="max-width: 120px;"></td>
                            <td th:text="${m.tipo}"></td>
                            <td th:text="${m.raza}" class="text-truncate" style="max-width: 100px;"></td>
                            <td th:text="${#temporals.format(m.fechaNacimiento, 'dd/MM/yyyy')}"
                                th:attr="data-order=${#temporals.format(m.fechaNacimiento, 'yyyy-MM-dd')}"></td>
                            <td>
                                <span th:text="${m.genero.name()}"
                                      th:classappend="${m.genero.name() == 'MACHO' ? 'badge bg-primary' : (m.genero.name() == 'HEMBRA' ? 'badge bg-danger' : 'badge bg-secondary')}"></span>
                            </td>
                            <td th:text="${m.usuario != null ? m.usuario.nombre : 'N/A'}" class="text-truncate" style="max-width: 150px;"></td>
                            <td class="text-center">
                                <i class="bi bi-exclamation-triangle-fill text-warning" th:if="${m.alerta}" title="Cita próxima"></i>
                            </td>
                            <td class="text-center">
                                <a th:href="@{/paciente/mascota/editar(id=${m.id_mascota})}" class="btn btn-sm btn-outline-primary btn-action" title="Editar">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                <a th:href="@{/paciente/mascota/eliminar(id=${m.id_mascota})}" class="btn btn-sm btn-outline-danger btn-action" title="Eliminar"
                                   onclick="return confirm('¿Seguro que desea eliminar esta mascota?')">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="footer mt-auto mt-2 text-white" th:insert="~{fragmentos :: Pie}"></footer>

<th:block th:insert="~{fragmentos :: Links-js}"/>
</body>
</html>