<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patitas al Rescate - Gestión de Mascota</title>
    <th:block th:insert="~{fragmentos :: Links-css}"/>
</head>
<body>
<!-- Cabecera -->
<div th:replace="~{fragmentos :: Cabecera}"></div>

<div class="main-container">
    <!-- FORMULARIO DE REGISTRO -->
    <div class="form-container">
        <div class="form-card">
            <div class="card-header">
                <h4>
                    <i class="fa-solid fa-paw"></i> Registrar Mascota
                </h4>
            </div>
            <div class="form-body">
                <form method="post" th:action="@{/paciente/mascota/guardar}" th:object="${mascota}" class="custom-form">
                    <!-- Mensaje de éxito -->
                    <div th:if="${exito}" class="alert-success">
                        <i class="bi bi-check-circle-fill"></i>
                        <span th:text="${exito}"></span>
                        <span class="close-btn" onclick="this.parentElement.style.display='none';">&times;</span>
                    </div>

                    <!-- Mensaje de error -->
                    <div th:if="${error}" class="alert-danger">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <span th:text="${error}"></span>
                        <span class="close-btn" onclick="this.parentElement.style.display='none';">&times;</span>
                    </div>

                    <input type="hidden" th:field="*{id_mascota}"/>

                    <div class="form-group">
                        <label for="nombre"><i class="bi bi-tag"></i> Nombre</label>
                        <input type="text" th:field="*{nombre}" id="nombre" placeholder="Ej. Firulais">
                        <div th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}" class="error"></div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tipo"><i class="bi bi-box"></i> Tipo</label>
                            <input type="text" th:field="*{tipo}" id="tipo" placeholder="Perro, gato...">
                            <div th:if="${#fields.hasErrors('tipo')}" th:errors="*{tipo}" class="error"></div>
                        </div>
                        <div class="form-group">
                            <label for="raza"><i class="bi bi-fingerprint"></i> Raza</label>
                            <input type="text" th:field="*{raza}" id="raza" placeholder="Labrador...">
                            <div th:if="${#fields.hasErrors('raza')}" th:errors="*{raza}" class="error"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="fechaNacimiento"><i class="bi bi-calendar2-week"></i> Fecha Nac.</label>
                            <input type="date" th:field="*{fechaNacimiento}" id="fechaNacimiento">
                            <div th:if="${#fields.hasErrors('fechaNacimiento')}" th:errors="*{fechaNacimiento}" class="error"></div>
                        </div>
                        <div class="form-group">
                            <label for="genero"><i class="bi bi-gender-ambiguous"></i> Género</label>
                            <select th:field="*{genero}" id="genero" required>
                                <option value="" disabled selected>Seleccione</option>
                                <option th:value="MACHO">Macho</option>
                                <option th:value="HEMBRA">Hembra</option>
                                <option th:value="OTRO">Otro</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="observacionesMedicas"><i class="bi bi-journal-medical"></i> Observaciones Médicas</label>
                        <textarea id="observacionesMedicas" th:field="*{observacionesMedicas}" rows="2"></textarea>
                        <div th:if="${#fields.hasErrors('observacionesMedicas')}" th:errors="*{observacionesMedicas}" class="error"></div>
                    </div>

                    <!-- Usuario (Dueño) -->
                    <div th:if="${#authorization.expression('!hasRole(''ROLE_PACIENTE'')')}" class="form-group">
                        <label><i class="bi bi-person"></i> Dueño</label>
                        <select th:field="*{usuario.id_usuario}">
                            <option value="" disabled selected>Seleccione un usuario</option>
                            <option th:each="u : ${usuarios}" th:value="${u.id_usuario}" th:text="${u.nombre + ' (' + u.username + ')'}"></option>
                        </select>
                        <div th:if="${#fields.hasErrors('usuario')}" th:errors="*{usuario}" class="error"></div>
                    </div>
                    <input type="hidden" th:if="${#authorization.expression('hasRole(''ROLE_PACIENTE'')')}" th:field="*{usuario.id_usuario}" th:value="${usuarios[0].id_usuario}"/>

                    <!-- Botones -->
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="bi bi-check-circle"></i> Guardar Mascota
                        </button>
                        <a href="/paciente/mascota/nuevo" class="btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- TABLA DE MASCOTAS -->
    <div class="table-container">
        <div class="table-card">
            <div class="card-header">
                <h4><i class="bi bi-collection"></i> Lista de Mascotas</h4>
            </div>
            <div class="table-wrapper">
                <table class="tablaData custom-table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Tipo</th>
                        <th>Raza</th>
                        <th>Nac.</th>
                        <th>Género</th>
                        <th>Dueño</th>
                        <th>Alerta</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="m : ${mascotas}">
                        <td class="text-center bold" th:text="${m.id_mascota}"></td>
                        <td th:text="${m.nombre}" class="truncate" style="max-width: 120px;"></td>
                        <td th:text="${m.tipo}"></td>
                        <td th:text="${m.raza}" class="truncate" style="max-width: 100px;"></td>
                        <td th:text="${#temporals.format(m.fechaNacimiento, 'dd/MM/yyyy')}"
                            th:attr="data-order=${#temporals.format(m.fechaNacimiento, 'yyyy-MM-dd')}"></td>
                        <td>
                        <span th:text="${m.genero.name()}"
                            <span class="badge genero-badge"
                                  th:classappend="${m.genero.name() == 'MACHO' ? 'macho' :
                             (m.genero.name() == 'HEMBRA' ? 'hembra' : 'otro')}">
                                   <span th:text="${m.genero}"></span>
                             </span>

                        </td>
                        <td th:text="${m.usuario != null ? m.usuario.nombre : 'N/A'}" class="truncate" style="max-width: 150px;"></td>
                        <td class="text-center">
                            <i class="bi bi-exclamation-triangle-fill text-warning" th:if="${m.alerta}" title="Cita próxima"></i>
                        </td>
                        <td class="text-center">
                            <a th:href="@{/paciente/mascota/editar(id=${m.id_mascota})}" class="btn-action btn-edit" title="Editar">
                                <i class="bi bi-pencil-square"></i>
                            </a>
                            <a th:href="@{/paciente/mascota/eliminar(id=${m.id_mascota})}" class="btn-action btn-delete" title="Eliminar"
                               onclick="return confirm('¿Seguro que desea eliminar esta mascota?')">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="footer mt-auto mt-2 text-white" th:insert="~{fragmentos :: Pie}"></footer>

<th:block th:insert="~{fragmentos :: Links-js}"/>
</body>
</html>